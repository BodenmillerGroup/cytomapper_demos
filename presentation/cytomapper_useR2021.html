<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Visualization of highly-multiplexed imaging data with cytomapper</title>
    <meta charset="utf-8" />
    <meta name="author" content="Nils Eling" />
    <meta name="date" content="2021-09-07" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/useR-fonts.css" rel="stylesheet" />
    <link rel="stylesheet" href="custom.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Visualization of highly-multiplexed imaging data with <code>cytomapper</code>
### Nils Eling
### Department of Quantitative Biomedicine, University of Zurich
### Institute for Molecular Health Sciences, ETH Zurich
### 09/07/2021

---

background-image: url(imgs/cytomapper_sticker.png)
background-size: 150px
background-position: 95% 10%
  


## The `cytomapper` R/Bioconductor package

Contains three broad functionalities:

* Visualization of pixel-intensities as composites of up to six channels (`plotPixels`)

* Visualization of cell-specific features on segmentation masks (`plotCells`)

* Interactive gating of cells and visualization of gated cells on images (`cytomapperShiny`)

### Installation

Via Bioconductor (release version):


```r
BiocManager::install("cytomapper")
```

or from Github (development version):


```r
remotes::install_github("BodenmillerGroup/cytomapper", build_vignettes = TRUE)
```

---

## Data structure

.pull-left[

* `cytomapper` uses a `SingleCellExperiment` data container to store cell-specific metadata and intensity features

* the new class `cytomapper::CytoImageList` stores individual `EBImage::Image` objects in form of a `S4Vectors::SimpleList` container

* visualization of cell-specific metadata is possible by linking a `CytoImageList` and `SingleCellExperiment` object via the function parameters `img_id` and `cell_id`

]

.pull-right[

![cytomapper overview figure](imgs/Overview.png)

]

&lt;div class="my-footer" style="height=100px;"&gt;&lt;a href="https://bioconductor.org/packages/release/bioc/html/SingleCellExperiment.html"&gt;https://bioconductor.org/packages/release/bioc/html/SingleCellExperiment.html&lt;/a&gt;&lt;br&gt;
&lt;a href="https://www.bioconductor.org/packages/release/bioc/html/EBImage.html"&gt;https://www.bioconductor.org/packages/release/bioc/html/EBImage.html&lt;/a&gt;&lt;br&gt;
&lt;a href="https://www.bioconductor.org/packages/release/bioc/html/S4Vectors.html"&gt;https://www.bioconductor.org/packages/release/bioc/html/S4Vectors.html&lt;/a&gt;&lt;/div&gt; 

---

## Reading in the data


```r
library(cytomapper)

# Read in 32-bit multi-channel images
(images &lt;- loadImages("../data/images/", pattern = ".tiff"))
```

```
## CytoImageList containing 3 image(s)
## names(3): E30_a0_full_clean G23_a0_full_clean J01_a0_full_clean 
## Each image contains 38 channel(s)
```

```r
# Read in 16-bit unsigned integer segmentation masks
(masks &lt;- loadImages("../data/masks/", pattern = ".tiff", as.is = TRUE))
```

```
## CytoImageList containing 3 image(s)
## names(3): E30_a0_full_mask G23_a0_full_mask J01_a0_full_mask 
## Each image contains 1 channel
```

```r
# Read in single-cell data
(sce &lt;- readRDS("../data/sce.rds"))
```

```
## class: SingleCellExperiment 
## dim: 38 5819 
## metadata(0):
## assays(2): counts exprs
## rownames(38): H3 SMA ... Ir191 Ir193
## rowData names(15): TubeNb MetalTag ... miCAT2 miCAT
## colnames(5819): E30_1 E30_2 ... J01_2173 J01_2174
## colData names(26): slide id ... Ethnicity BMI
## reducedDimNames(0):
## mainExpName: NULL
## altExpNames(0):
```

---

## Formatting the data


```r
# Add channel names
channelNames(images) &lt;- rownames(sce)

# Add image name to metadata
(mcols(images) &lt;- mcols(masks) &lt;- DataFrame(ImageName = c("E30", "G23", "J01")))
```

```
## DataFrame with 3 rows and 1 column
##     ImageName
##   &lt;character&gt;
## 1         E30
## 2         G23
## 3         J01
```

---

## Measuring object features


```r
#sce_2 &lt;- measureObjects(mask = masks, image = images, img_id = "ImageName")
#sce_2
```

---

## Visualize multi-channel images


```r
plotPixels(image = images,
           colour_by = c("PIN", "CD4", "CD8a"), 
           colour = list(PIN = c("black", "yellow"),
                         CD4 = c("black", "blue"),
                         CD8a = c("black", "red")),
           bcg = list(PIN = c(0, 10, 1),
                      CD4 = c(0, 8, 1),
                      CD8a = c(0, 10, 1)),
           image_title = list(text = c("Non-diabetic",
                                       "Recent onset T1D",
                                       "Long duration T1D")),
           scale_bar = list(length = 100,
                            label = expression("100 " ~ mu * "m")))
```

![](cytomapper_useR2021_files/figure-html/unnamed-chunk-1-1.png)&lt;!-- --&gt;

---

## Visualize segmented cells


```r
cur_sce &lt;- sce[,sce$CellType %in% c("beta", "alpha", "delta", "Tc", "Th")]
plotCells(mask = masks,
          object = cur_sce,
          cell_id = "CellNumber",
          img_id = "ImageName",
          colour_by = "CellType",
          image_title = list(text = c("Non-diabetic",
                                      "Recent onset T1D",
                                      "Long duration T1D"),
                             colour = "black"),
          scale_bar = list(length = 100,
                           label = expression("100 " ~ mu * "m"),
                           colour = "black"),
          missing_colour = "white",
          background_colour = "gray")
```

![](cytomapper_useR2021_files/figure-html/unnamed-chunk-2-1.png)&lt;!-- --&gt;

---

## Outline cells on images


```r
plotPixels(image = images,
           object = cur_sce,
           mask = masks,
           cell_id = "CellNumber",
           img_id = "ImageName",
           colour_by = c("PIN", "CD4", "CD8a"), 
           outline_by = "CellType",
           colour = list(PIN = c("black", "yellow"),
                         CD4 = c("black", "blue"),
                         CD8a = c("black", "red")),
           bcg = list(PIN = c(0, 10, 1),
                      CD4 = c(0, 8, 1),
                      CD8a = c(0, 10, 1)),
           image_title = list(text = c("Non-diabetic",
                                       "Recent onset T1D",
                                       "Long duration T1D")),
           scale_bar = list(length = 100,
                            label = expression("100 " ~ mu * "m")),
           thick = TRUE)
```

![](cytomapper_useR2021_files/figure-html/unnamed-chunk-3-1.png)&lt;!-- --&gt;

---

## Acknowledgements and useful links

---

## Session Info



```r
sessionInfo(package = "cytomapper")
```

```
## R version 4.1.0 (2021-05-18)
## Platform: x86_64-apple-darwin17.0 (64-bit)
## Running under: macOS Catalina 10.15.7
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRblas.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## character(0)
## 
## other attached packages:
## [1] cytomapper_1.4.1
## 
## loaded via a namespace (and not attached):
##   [1] utils_4.1.0                 bitops_1.0-7               
##   [3] matrixStats_0.59.0          EBImage_4.34.0             
##   [5] RColorBrewer_1.1-2          GenomeInfoDb_1.28.0        
##   [7] tools_4.1.0                 bslib_0.2.5.1              
##   [9] utf8_1.2.1                  R6_2.5.0                   
##  [11] svgPanZoom_0.3.4            HDF5Array_1.20.0           
##  [13] vipor_0.4.5                 DBI_1.1.1                  
##  [15] BiocGenerics_0.38.0         colorspace_2.0-1           
##  [17] rhdf5filters_1.4.0          raster_3.4-13              
##  [19] sp_1.4-5                    gridExtra_2.3              
##  [21] tidyselect_1.1.1            compiler_4.1.0             
##  [23] Biobase_2.52.0              datasets_4.1.0             
##  [25] DelayedArray_0.18.0         base_4.1.0                 
##  [27] sass_0.4.0                  scales_1.1.1               
##  [29] systemfonts_1.0.2           stringr_1.4.0              
##  [31] digest_0.6.27               tiff_0.1-8                 
##  [33] fftwtools_0.9-11            rmarkdown_2.9              
##  [35] svglite_2.0.0               XVector_0.32.0             
##  [37] jpeg_0.1-8.1                pkgconfig_2.0.3            
##  [39] htmltools_0.5.1.1           MatrixGenerics_1.4.0       
##  [41] highr_0.9                   fastmap_1.1.0              
##  [43] grDevices_4.1.0             htmlwidgets_1.5.3          
##  [45] rlang_0.4.11                xaringan_0.21.1            
##  [47] shiny_1.6.0                 jquerylib_0.1.4            
##  [49] generics_0.1.0              jsonlite_1.7.2             
##  [51] BiocParallel_1.26.0         dplyr_1.0.6                
##  [53] RCurl_1.98-1.3              magrittr_2.0.1             
##  [55] GenomeInfoDbData_1.2.6      Matrix_1.3-3               
##  [57] Rcpp_1.0.6                  ggbeeswarm_0.6.0           
##  [59] munsell_0.5.0               S4Vectors_0.30.0           
##  [61] Rhdf5lib_1.14.1             fansi_0.5.0                
##  [63] abind_1.4-5                 viridis_0.6.1              
##  [65] lifecycle_1.0.0             stringi_1.6.2              
##  [67] yaml_2.2.1                  SummarizedExperiment_1.22.0
##  [69] zlibbioc_1.38.0             rhdf5_2.36.0               
##  [71] grid_4.1.0                  parallel_4.1.0             
##  [73] promises_1.2.0.1            shinydashboard_0.7.1       
##  [75] crayon_1.4.1                methods_4.1.0              
##  [77] lattice_0.20-44             locfit_1.5-9.4             
##  [79] knitr_1.33                  pillar_1.6.1               
##  [81] GenomicRanges_1.44.0        codetools_0.2-18           
##  [83] stats4_4.1.0                glue_1.4.2                 
##  [85] evaluate_0.14               png_0.1-7                  
##  [87] vctrs_0.3.8                 httpuv_1.6.1               
##  [89] graphics_4.1.0              gtable_0.3.0               
##  [91] purrr_0.3.4                 assertthat_0.2.1           
##  [93] ggplot2_3.3.4               xfun_0.24                  
##  [95] mime_0.10                   xtable_1.8-4               
##  [97] later_1.2.0                 viridisLite_0.4.0          
##  [99] SingleCellExperiment_1.14.1 tibble_3.1.2               
## [101] stats_4.1.0                 beeswarm_0.4.0             
## [103] IRanges_2.26.0              ellipsis_0.3.2
```

---






    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>

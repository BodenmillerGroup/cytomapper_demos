---
title: "Example script to highlight the usage of the `cytomapper` package"
author: "Nils Eling"
date: "`r Sys.Date()`"
output:     
    md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script serves as an example to highlight the usage of the [cytomapper](https://www.bioconductor.org/packages/release/bioc/html/cytomapper.html) 
R/Bioconductor package. It was written for the [Indiana Oâ€™Brien Center Microscopy Workshop](http://static.medicine.iupui.edu/obrien/2021Schedule.pdf)
in June 2021.

## Prerequisites

To use this script, first you will need to [install R](https://www.r-project.org/) 
and install the `cytomapper` package via:

```{r install-cytomapper, eval=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("cytomapper")
```

For convenience, please open the provided `cytomapper_demos.Rproj` file.
This will correctly set the working directory.

For complete instructions on how to use the `cytomapper` package, please refer
to the [official vignette](https://bioconductor.org/packages/release/bioc/vignettes/cytomapper/inst/doc/cytomapper.html).

## Reading in example data

In the first instance, we will read in the example data provided in this repository.
To read in images, the `cytomapper` package provides the `loadImages` function.
The cell-specific mean ion counts and metadata are stored in form of a 
[SingleCellExperiment](https://bioconductor.org/packages/release/bioc/html/SingleCellExperiment.html) object.

```{r read-in-data, message=FALSE}
library(cytomapper)

# Read in multi-channel images
(images <- loadImages("../data/images/", pattern = ".tiff"))

# Read in masks
(masks <- loadImages("../data/masks/", pattern = ".tiff", as.is = TRUE))

# Read in single-cell data
(sce <- readRDS("../data/sce.rds"))
```

Here, mean ion counts are stored in `counts(sce)` and cell-associated metadata
are stored in `colData(sce)`.

## Add image metadata

To easily select markers for display, the `channelNames` of the multi-channel
image object needs to be set. 
Furthermore, to match segmentation masks with multi-channel images, image-level
metadata needs to be added.

```{r}
# Add channel names
channelNames(images) <- rownames(sce)

# Add image name to metadata
(mcols(images) <- mcols(masks) <- DataFrame(ImageName = c("E30", "G23", "J01")))
```

## Visualize multi-channel images

In the first instance, we can use `cytomapper` to visualize pixel intensities of 
multi-channel images. The `plotPixels` function takes at least the `images` object
storing multi-channel images. Via the `colour_by` parameter, up to six channels
can be selected for display. The `colour` parameter specifies the range of the 
colour palette used to display the individual channels. Background, contrast and
alpha of each channel can be set via the `bcg` parameter. Visual appearance of the
image title can be adjusted via setting `image_title` and the scale bar can be 
set via the `scale_bar` parameter.

Here, we can display the markers pro-insulin (PIN, beta cells), CD4 (helper T cells) 
and CD8a (cytotoxic T cells).

```{r}
plotPixels(image = images,
           colour_by = c("PIN", "CD4", "CD8a"), 
           colour = list(PIN = c("black", "yellow"),
                         CD4 = c("black", "blue"),
                         CD8a = c("black", "red")),
           bcg = list(PIN = c(0, 10, 1),
                      CD4 = c(0, 8, 1),
                      CD8a = c(0, 10, 1)),
           image_title = list(text = c("Non-diabetic",
                                       "Recent onset T1D",
                                       "Long duration T1D")),
           scale_bar = list(length = 100,
                            label = expression("100 " ~ mu * "m")))
```

## Visualize segmented cells

By incorporating information stored in the `SingleCellExperiment` object, cell-specific
metadata can be displayed on the segmentation masks. Here, each cell is defined
as a set of pixels with the same integer. The `SingleCellExperiment` object
must contain an entry storing these integer ids (here the entry can be accessed
via `colData(sce)$CellNumber`). Furthermore, `colData(sce)$ImageName` stores
the name of the image to which each cell belongs. This parameter is needed
to map each cell to its associated segmentation mask.

Here, we subset the `SingleCellExperiment` object to only contain islet cells
(`alpha`, `beta` and `delta`) and helper T cells (`Th`) and cytotoxic T cells (`Tc`).
In that way, only the selected cells are displayed. All other cells are coloured
using the colour specified via the `missing_colour` parameter.

```{r}
cur_sce <- sce[,sce$CellType %in% c("beta", "alpha", "delta", "Tc", "Th")]

plotCells(mask = masks,
          object = cur_sce,
          cell_id = "CellNumber",
          img_id = "ImageName",
          colour_by = "CellType",
          image_title = list(text = c("Non-diabetic",
                                      "Recent onset T1D",
                                      "Long duration T1D"),
                             colour = "black"),
          scale_bar = list(length = 100,
                           label = expression("100 " ~ mu * "m"),
                           colour = "black"),
          missing_colour = "white",
          background_colour = "gray")
```

## Outline cells on images

In the final step, we can combine the multi-channel `images`, the segmentation
`masks` and the single-cell data contained in the `SingleCellExperiment` object
to outline the selected cells on top of the composite images. 

```{r}
plotPixels(image = images,
           object = cur_sce,
           mask = masks,
           cell_id = "CellNumber",
           img_id = "ImageName",
           colour_by = c("PIN", "CD4", "CD8a"), 
           outline_by = "CellType",
           colour = list(PIN = c("black", "yellow"),
                         CD4 = c("black", "blue"),
                         CD8a = c("black", "red")),
           bcg = list(PIN = c(0, 10, 1),
                      CD4 = c(0, 8, 1),
                      CD8a = c(0, 10, 1)),
           image_title = list(text = c("Non-diabetic",
                                       "Recent onset T1D",
                                       "Long duration T1D")),
           scale_bar = list(length = 100,
                            label = expression("100 " ~ mu * "m")),
           thick = TRUE)
```

## Gate cells on images

Finally, the `cytomapperShiny` function can be used to gate cells based on their
expression values. Gates cells are shown in form of outlines on the images.

```{r}
if (interactive()) {
    cytomapperShiny(sce, mask = masks, image = images, 
                    cell_id = "CellNumber", img_id = "ImageName")
}
```

## Session info

```{r sessionInfo}
sessionInfo()
```